name: Deploy Portfolio

on:
  push:
    branches:
      - main   # à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹€à¸›à¹‡à¸™ branch à¸—à¸µà¹ˆà¸„à¸¸à¸“à¹ƒà¸Šà¹‰à¸ˆà¸£à¸´à¸‡

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout source code
      - name: Checkout code
        uses: actions/checkout@v3

      # à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ SSH Key à¹€à¸žà¸·à¹ˆà¸­à¹€à¸‚à¹‰à¸² server
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # à¸ªà¹ˆà¸‡à¹„à¸Ÿà¸¥à¹Œà¹„à¸›à¸¢à¸±à¸‡ Droplet
      - name: Deploy with rsync
        run: |
          rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no" \
            ./ root@${{ secrets.SERVER_IP }}:/var/www/portfolio_2024/

          ssh -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} << 'EOF'
            cd /var/www/portfolio_2024

            # ðŸ”¹ à¸«à¸¢à¸¸à¸” pm2 portfolio à¸–à¹‰à¸²à¸¡à¸±à¸™à¸¢à¸±à¸‡à¸£à¸±à¸™à¸­à¸¢à¸¹à¹ˆ
            if command -v pm2 &> /dev/null; then
              pm2 delete portfolio || true
            fi

            # ðŸ”¹ deploy à¸”à¹‰à¸§à¸¢ docker-compose
            docker compose down || true
            docker compose up -d --build
          EOF
